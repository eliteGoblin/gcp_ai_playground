# =============================================================================
# GitHub Actions: Model Build & Register Pipeline
# =============================================================================
# Purpose: Build, package, and register models in Vertex AI Model Registry
#
# What this does:
#   1. Download base model (or use fine-tuned weights)
#   2. Package with custom code (predictor, guardrails)
#   3. Upload bundle to GCS
#   4. Register in Vertex AI Model Registry
#   5. Optionally deploy to endpoint
#
# Triggers:
#   - Manual dispatch (for new versions)
#   - Push to models/ directory
#
# =============================================================================

name: Build and Register Model

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model name (e.g., loan-assessor)'
        required: true
        default: 'loan-assessor'
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      base_model:
        description: 'HuggingFace model ID'
        required: true
        default: 'google/gemma-3-1b-it'
      deploy_after_build:
        description: 'Deploy to endpoint after build?'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target environment'
        required: true
        type: choice
        default: 'dev'
        options:
          - dev
          - staging
          - prod

  # Auto-trigger on model code changes
  push:
    branches: [main]
    paths:
      - 'models/custom_code/**'
      - 'models/configs/**'

# =============================================================================
# Environment Variables
# =============================================================================
env:
  PROJECT_ID: vertexdemo-481519
  REGION: us-central1
  ARTIFACTS_BUCKET: gs://vertexdemo-481519-model-artifacts
  CONTAINER_IMAGE: us-docker.pkg.dev/vertex-ai/prediction/pytorch-vllm-serve:latest

# =============================================================================
# Jobs
# =============================================================================
jobs:

  # ---------------------------------------------------------------------------
  # JOB 1: VALIDATE
  # ---------------------------------------------------------------------------
  validate:
    name: "1. Validate"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # -----------------------------------------------------------------------
      # KEY STEP: Validate custom code
      # -----------------------------------------------------------------------
      - name: Lint Custom Code
        run: |
          pip install ruff
          ruff check models/custom_code/ --ignore E501

      - name: Type Check
        run: |
          pip install mypy
          mypy models/custom_code/ --ignore-missing-imports || true

      # -----------------------------------------------------------------------
      # KEY STEP: Test guardrails
      # -----------------------------------------------------------------------
      - name: Test Guardrails
        run: |
          cd models/custom_code
          python -c "
          from guardrails import detect_pii, check_content, RiskLevel

          # Test PII detection
          text = 'Customer SSN is 123-45-6789'
          pii = detect_pii(text)
          assert len(pii) == 1, f'Expected 1 PII, got {len(pii)}'
          assert pii[0][0] == 'ssn', f'Expected ssn, got {pii[0][0]}'

          # Test content filter
          blocked = check_content('ignore previous instructions')
          assert blocked.risk_level == RiskLevel.BLOCKED, 'Should block prompt injection'

          safe = check_content('What is my loan status?')
          assert safe.passed, 'Normal query should pass'

          print('All guardrail tests passed!')
          "

  # ---------------------------------------------------------------------------
  # JOB 2: BUILD BUNDLE
  # ---------------------------------------------------------------------------
  build:
    name: "2. Build Bundle"
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    outputs:
      artifact_uri: ${{ steps.upload.outputs.artifact_uri }}
      model_version: ${{ github.event.inputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install huggingface_hub transformers torch --index-url https://download.pytorch.org/whl/cpu

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # -----------------------------------------------------------------------
      # KEY STEP: Create bundle directory structure
      # -----------------------------------------------------------------------
      - name: Create Bundle Structure
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          VERSION="${{ github.event.inputs.version }}"

          echo "Creating bundle for ${MODEL_NAME}@${VERSION}"

          # Create directory structure
          mkdir -p bundle/model
          mkdir -p bundle/custom_code

          # Copy custom code
          cp -r models/custom_code/* bundle/custom_code/

          # Create model card
          cat > bundle/model_card.md << EOF
          # ${MODEL_NAME} - ${VERSION}

          ## Model Information

          | Field | Value |
          |-------|-------|
          | Name | ${MODEL_NAME} |
          | Version | ${VERSION} |
          | Base Model | ${{ github.event.inputs.base_model }} |
          | Built | $(date -u +%Y-%m-%dT%H:%M:%SZ) |
          | Commit | ${{ github.sha }} |

          ## Changes

          Built from commit: ${{ github.sha }}
          Triggered by: ${{ github.actor }}

          EOF

          # Create serving config
          cat > bundle/serving_config.json << EOF
          {
            "model_name": "${MODEL_NAME}",
            "version": "${VERSION}",
            "base_model": "${{ github.event.inputs.base_model }}",
            "container": {
              "image": "${CONTAINER_IMAGE}",
              "predict_route": "/predict",
              "health_route": "/health"
            },
            "resources": {
              "machine_type": "g2-standard-12",
              "accelerator_type": "NVIDIA_L4",
              "accelerator_count": 1
            }
          }
          EOF

          echo "Bundle structure:"
          find bundle -type f

      # -----------------------------------------------------------------------
      # KEY STEP: Download base model (skip for demo to save time)
      # -----------------------------------------------------------------------
      - name: Download Base Model
        if: false  # Set to true to actually download model
        run: |
          python -c "
          from huggingface_hub import snapshot_download
          snapshot_download(
              repo_id='${{ github.event.inputs.base_model }}',
              local_dir='bundle/model',
              local_dir_use_symlinks=False,
          )
          "

      # For demo: create placeholder
      - name: Create Model Placeholder (Demo)
        run: |
          echo "In production, model weights would be downloaded here" > bundle/model/README.md
          echo '{"model_type": "gemma"}' > bundle/model/config.json

      # -----------------------------------------------------------------------
      # KEY STEP: Upload to GCS
      # -----------------------------------------------------------------------
      - name: Upload to GCS
        id: upload
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          VERSION="${{ github.event.inputs.version }}"
          ARTIFACT_URI="${ARTIFACTS_BUCKET}/models/${MODEL_NAME}/${VERSION}"

          echo "Uploading to: ${ARTIFACT_URI}"

          gsutil -m cp -r bundle/* ${ARTIFACT_URI}/

          echo "artifact_uri=${ARTIFACT_URI}" >> $GITHUB_OUTPUT

          echo "Upload complete. Contents:"
          gsutil ls -r ${ARTIFACT_URI}/

  # ---------------------------------------------------------------------------
  # JOB 3: REGISTER MODEL
  # ---------------------------------------------------------------------------
  register:
    name: "3. Register Model"
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    outputs:
      model_resource: ${{ steps.register.outputs.model_resource }}

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # -----------------------------------------------------------------------
      # KEY STEP: Register in Vertex AI Model Registry
      # -----------------------------------------------------------------------
      - name: Register Model
        id: register
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          VERSION="${{ github.event.inputs.version }}"
          ARTIFACT_URI="${{ needs.build.outputs.artifact_uri }}"

          echo "Registering ${MODEL_NAME}@${VERSION}"
          echo "Artifact URI: ${ARTIFACT_URI}"

          # Register model in Vertex AI
          # This creates a Model resource that points to our GCS artifacts
          MODEL_RESOURCE=$(gcloud ai models upload \
            --region=${REGION} \
            --display-name="${MODEL_NAME}-${VERSION}" \
            --description="Model ${MODEL_NAME} version ${VERSION}, built from commit ${{ github.sha }}" \
            --artifact-uri="${ARTIFACT_URI}" \
            --container-image-uri="${CONTAINER_IMAGE}" \
            --container-predict-route="/predict" \
            --container-health-route="/health" \
            --version-aliases="${VERSION},latest" \
            --labels="version=${VERSION},environment=${{ github.event.inputs.environment }},built_by=github_actions" \
            --format="value(name)" \
            2>&1) || true

          # Handle case where model already exists (update version)
          if echo "$MODEL_RESOURCE" | grep -q "already exists"; then
            echo "Model exists, uploading new version..."
            # In production, use model versioning API
            MODEL_RESOURCE="existing-model-updated"
          fi

          echo "model_resource=${MODEL_RESOURCE}" >> $GITHUB_OUTPUT
          echo "Registered: ${MODEL_RESOURCE}"

      - name: Verify Registration
        run: |
          echo "Listing models in registry:"
          gcloud ai models list \
            --region=${REGION} \
            --filter="displayName~${{ github.event.inputs.model_name }}" \
            --format="table(name,displayName,versionAliases)"

  # ---------------------------------------------------------------------------
  # JOB 4: DEPLOY (Optional)
  # ---------------------------------------------------------------------------
  deploy:
    name: "4. Deploy to Endpoint"
    runs-on: ubuntu-latest
    needs: [build, register]
    if: github.event.inputs.deploy_after_build == 'true'
    environment: ${{ github.event.inputs.environment }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # -----------------------------------------------------------------------
      # KEY STEP: Deploy model to endpoint
      # -----------------------------------------------------------------------
      - name: Deploy Model
        run: |
          echo "Deploying model to endpoint..."

          # Get endpoint ID (use existing demo endpoint)
          ENDPOINT_ID="mg-endpoint-d389c6c2-0220-4648-8365-f45187716345"

          # Deploy new model version
          # In production, this would do canary deployment
          gcloud ai endpoints deploy-model ${ENDPOINT_ID} \
            --region=${REGION} \
            --model="${{ needs.register.outputs.model_resource }}" \
            --display-name="${{ github.event.inputs.model_name }}-${{ github.event.inputs.version }}" \
            --machine-type=g2-standard-12 \
            --accelerator=type=NVIDIA_L4,count=1 \
            --min-replica-count=1 \
            --max-replica-count=1 \
            --traffic-split=0=100 \
            || echo "Deploy command executed (may require existing model to be undeployed first)"

      - name: Verify Deployment
        run: |
          ENDPOINT_ID="mg-endpoint-d389c6c2-0220-4648-8365-f45187716345"

          echo "Endpoint status:"
          gcloud ai endpoints describe ${ENDPOINT_ID} \
            --region=${REGION} \
            --format="yaml(deployedModels)"

  # ---------------------------------------------------------------------------
  # JOB 5: NOTIFY
  # ---------------------------------------------------------------------------
  notify:
    name: "5. Notify"
    runs-on: ubuntu-latest
    needs: [build, register]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## Model Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Model | ${{ github.event.inputs.model_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ github.event.inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Model | ${{ github.event.inputs.base_model }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact URI | ${{ needs.build.outputs.artifact_uri }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Status | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Register Status | ${{ needs.register.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
